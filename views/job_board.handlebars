<div class="row">
  <div class="header columns">
    <ul class="dropdown menu" data-dropdown-menu>
      <li>
        <a href="#Item-1">Get Started</a>
        <ul class="menu">
          <li><a href="#Item-1A">See your prospects</a></li>
          <li>
            <a href="#Item-1B">Action-steps</a>
          </li>
          <li><a href="#Item-1C">Contact an advisor</a></li>
        </ul>
      </li>
      <li><a href="/">Home</a></li>
      <li><a href="#Item-4">About Us</a></li>
    </ul>
  </div>
</div>

<div class="table">
  <div class="grid-container">
    <div class="grid-x grid-margin-x small-up-6 medium-up-6">
      <div class="cell" ondrop="drop(event)" ondragover="allowDrop(event)" id="planning-to-apply">
        <div class="card">
          <div class="card-section">
            <h4>Planning to Apply</h4>
            <p>
              <button class="button tiny" data-open="exampleModal1">
                Add a job
              </button>
            </p>

            <!-- hidden modal -->
            <div class="reveal" id="exampleModal1" data-reveal>
              <form id="submit-new-job-form" action="">
                <label for="title">Job Title:</label>
                <input type="text" name="title" id="job-title" />
                <label for="company">Company Name:</label>
                <input type="text" name="company" id="company-name" />
                <label for="position">Position:</label>
                <input type="text" name="position" id="position" />
                <label for="stage">Stage:</label>
                <select id="stage">
                  <option value="Planning to Apply">Planning to Apply</option>
                  <option value="Applied">Applied</option>
                  <option value="Phone Screen">Phone Screen</option>
                  <option value="On Site">On Site</option>
                  <option value="Offers">Offers</option>
                  <option value="Rejected">Rejected</option>
                </select>
                <button class="button success" data-close aria-label="Close modal" id="submit-new-job">
                  Submit
                </button>
              </form>
              {{!-- <button class="close-button" data-close aria-label="Close modal" type="button">
                <span aria-hidden="true">&times;</span>
              </button> --}}
            </div>

            <!-- <div
              class="kanban card"
              draggable="true"
              ondragstart="drag(event)"
              data-id="1"
            >
              <div class="card-section">
                <h4>This is a card.</h4>
                <p>
                  It has an easy to override visual style, and is appropriately
                  subdued.
                </p>
              </div>
            </div> -->
          </div>
        </div>
        {{#each jobs}}
        {{#ifEquals this.stage "Planning to Apply"}}

        <div class="kanban card" draggable="true" ondragstart="drag(event)" data-id="{{ this.id }}">
          <div class="card-section">
            <h4>{{ this.jobName }}</h4>
            <p>{{ this.company }}</p>
            <p>{{ this.position }}</p>
            <p>{{ this.stage }}</p>
          </div>
        </div>

        {{/ifEquals}}
        {{/each}}
      </div>
      <div class="cell" ondrop="drop(event)" ondragover="allowDrop(event)" id="applied">
        <div class="card">
          <div class="card-section">
            <h4>Applied</h4>
          </div>
        </div>
        {{#each jobs}}
        {{#ifEquals this.stage "Applied"}}

        <div class="kanban card" draggable="true" ondragstart="drag(event)" data-id="{{ this.id }}">
          <div class="card-section">
            <h4>{{ this.jobName }}</h4>
            <p>{{ this.company }}</p>
            <p>{{ this.position }}</p>
            <p>{{ this.stage }}</p>
          </div>
        </div>

        {{/ifEquals}}
        {{/each}}
      </div>
      <div class="cell" ondrop="drop(event)" ondragover="allowDrop(event)" id="phone-screen">
        <div class="card">
          <div class="card-section">
            <h4>Phone Screen</h4>
          </div>
        </div>
        {{#each jobs}}
        {{#ifEquals this.stage "Phone Screen"}}

        <div class="kanban card" draggable="true" ondragstart="drag(event)" data-id="{{ this.id }}">
          <div class="card-section">
            <h4>{{ this.jobName }}</h4>
            <p>{{ this.company }}</p>
            <p>{{ this.position }}</p>
            <p>{{ this.stage }}</p>
          </div>
        </div>

        {{/ifEquals}}
        {{/each}}
      </div>
      <div class="cell" ondrop="drop(event)" ondragover="allowDrop(event)" id="on-site">
        <div class="card">
          <div class="card-section">
            <h4>On Site</h4>
          </div>
        </div>
        {{#each jobs}}
        {{#ifEquals this.stage "On Site"}}
        <div class="kanban card" draggable="true" ondragstart="drag(event)" data-id="{{ this.id }}">
          <div class="card-section">
            <h4>{{ this.jobName }}</h4>
            <p>{{ this.company }}</p>
            <p>{{ this.position }}</p>
            <p>{{ this.stage }}</p>
          </div>
        </div>

        {{/ifEquals}}
        {{/each}}
      </div>
      <div class="cell" ondrop="drop(event)" ondragover="allowDrop(event)" id="offers">
        <div class="card">
          {{!-- <img src="assets/img/generic/rectangle-1.jpg" /> --}}
          <div class="card-section">
            <h4>Offers</h4>
          </div>
        </div>
        {{#each jobs}}
        {{#ifEquals this.stage "Offers"}}

        <div class="kanban card" draggable="true" ondragstart="drag(event)" data-id="{{ this.id }}">
          <div class="card-section">
            <h4>{{ this.jobName }}</h4>
            <p>{{ this.company }}</p>
            <p>{{ this.position }}</p>
            <p>{{ this.stage }}</p>
          </div>
        </div>

        {{/ifEquals}}
        {{/each}}
      </div>
      <div class="cell" ondrop="drop(event)" ondragover="allowDrop(event)" id="rejected">
        <div class="card">
          {{!-- <img src="assets/img/generic/rectangle-1.jpg" /> --}}
          <div class="card-section">
            <h4>Rejected</h4>
          </div>
        </div>
        {{#each jobs}}
        {{#ifEquals this.stage "Rejected"}}

        <div class="kanban card" draggable="true" ondragstart="drag(event)" data-id="{{ this.id }}">
          <div class="card-section">
            <h4>{{ this.jobName }}</h4>
            <p>{{ this.company }}</p>
            <p>{{ this.position }}</p>
            <p>{{ this.stage }}</p>
          </div>
        </div>

        {{/ifEquals}}
        {{/each}}
      </div>
    </div>
  </div>
</div>
<!-- had to import jquery here for it to work for some reason.. -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"
  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
<script>
  //event listener for add new job btn
  const newJobModal = $("#exampleModal1");
  const addJob = $("#submit-new-job-form");
  addJob.on("submit", function (event) {
    event.preventDefault();
    console.log("test");
    const obj = {
      jobName: $("#job-title").val().trim(),
      company: $("#company-name").val().trim(),
      position: $("#position").val().trim(),
      stage: $("#stage").val().trim(),
    };
    $.ajax({
      type: "POST",
      url: "api/job",
      data: obj,
    }).then(function (data) {
      console.log(data);
      location.reload();
    });
    //not sure this is the best solution to hide it
    // newJobModal.attr("style", "display:none");
  });

  const dragStart = (event) => {
    event.currentTarget.classList.add("dragging");
  };

  const dragEnd = (event) => {
    event.currentTarget.classList.remove("dragging");
  };

  Array.from(document.querySelectorAll(".card")).forEach((card) => {
    card.addEventListener("dragstart", dragStart);
    card.addEventListener("dragend", dragEnd);
  });

  const drag = (event) => {
    event.dataTransfer.setData("text/html", event.currentTarget.outerHTML);
    event.dataTransfer.setData("text/plain", event.currentTarget.dataset.id);
  };

  const dragEnter = (event) => {
    event.currentTarget.classList.add("drop");
  };

  const dragLeave = (event) => {
    event.currentTarget.classList.remove("drop");
  };

  Array.from(document.querySelectorAll(".column")).forEach((column) => {
    column.addEventListener("dragenter", dragEnter);
    column.addEventListener("dragleave", dragLeave);
  });

  const drop = (event) => {
    Array.from(document.querySelectorAll(".column")).forEach((column) =>
      column.classList.remove("drop")
    );

    document
      .querySelector(`[data-id="${event.dataTransfer.getData("text/plain")}"]`)
      .remove();

    event.currentTarget.innerHTML =
      event.currentTarget.innerHTML + event.dataTransfer.getData("text/html");
    //console.log(event.currentTarget.lastElementChild.getAttribute("data-id"))
    const id = event.currentTarget.lastElementChild.getAttribute("data-id");
    const stage = event.currentTarget.lastElementChild.parentNode.getAttribute(
      "id"
    );
    let newStage;
    if (stage === "planning-to-apply") {
      newStage = "Planning to Apply";
    } else if (stage == "applied") {
      newStage = "Applied";
    } else if (stage == "phone-screen") {
      newStage = "Phone Screen";
    } else if (stage == "on-site") {
      newStage = "On Site";
    } else if (stage == "offers") {
      newStage = "Offers";
    } else if (stage == "rejected") {
      newStage = "Rejected";
    }
    console.log("NEWSTAGE: " + newStage);
    const data = {
      stage: newStage,
      id: id,
    };
    console.log("ID: " + id);
    $.ajax({
      url: "api/job",
      type: "PUT",
      data: data,
    }).then(function (data) {
      console.log("successfully changed status");
      location.reload();
    });
  };

  const allowDrop = (event) => {
    event.preventDefault();
    // console.log(event.currentTarget.lastElementChild.getAttribute("data-id"));
  };
</script>